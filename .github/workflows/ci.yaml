name: Build And Release Pkgs
on:
  workflow_dispatch:

jobs:
  unit-tests:
    name: unit-test-${{ matrix.module }}
    runs-on: ubuntu-latest
    strategy:
      matrix:
        module: [TestEngine.Api, TestEngine.Worker, TestEngine.DeployVerifier]
    permissions:
      contents: read
      actions: read
      pull-requests: write # needed for coverage comments
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-go@v4
        with:
          go-version: ^1.26
      - name: Test ${{ matrix.module }} module
        working-directory: ${{ matrix.module }}
        run: |
          go mod download
          go test -cover -coverprofile=../coverage-${{ matrix.module }}.out -covermode=atomic ./...
          go tool cover -func=../coverage-${{ matrix.module }}.out
      - name: check ${{ matrix.module }} test coverage
        uses: vladopajic/go-test-coverage@v2
        with:
          profile: ./coverage-${{ matrix.module }}.out
          threshold-total: 60
          source-dir: ./${{ matrix.module }}
      
  lint:
    name: lint-${{ matrix.module }}
    runs-on: ubuntu-latest
    strategy:
      matrix:
        module: [TestEngine.Api, TestEngine.Worker, TestEngine.DeployVerifier]
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-go@v4
        with:
          go-version: ^1.26
      - name: Install tools
        run: make install-tools
      - name: Lint ${{ matrix.module }} module
        working-directory: ${{ matrix.module }}
        run: |
          go mod tidy
          golangci-lint run --config ../.github/.golangci.yml --timeout 5m ./...
  
  vuln:
    name: check-sec-${{ matrix.module }}
    runs-on: ubuntu-latest
    strategy:
      matrix:
        module: [TestEngine.Api, TestEngine.Worker, TestEngine.DeployVerifier]
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-go@v4
        with:
          go-version: ^1.26
      - name: Run vulnerability scan on ${{ matrix.module }} module
        run: make check-sec PKG=${{ matrix.module }}

  # Check that all unit tests passed
  unit-tests-check:
    name: "Unit tests status check"
    runs-on: ubuntu-latest
    needs: unit-tests
    if: always()
    steps:
      - name: Check unit test results
        run: |
          echo "Unit tests completed"
          # This job will fail if any of the matrix unit test jobs failed
          if [[ "${{ needs.unit-tests.result }}" != "success" ]]; then

            echo "Some unit tests failed"
            exit 1
          fi
          echo "All unit tests passed"

  # Check that all lint jobs passed  
  lint-check:
    name: "Lint status check"
    runs-on: ubuntu-latest
    needs: lint
    if: always()
    steps:
      - name: Check lint results
        run: |
          echo "Lint jobs completed"
          # This job will fail if any of the matrix lint jobs failed
          if [[ "${{ needs.lint.result }}" != "success" ]]; then
            echo "Some lint jobs failed"
            exit 1
          fi
          echo "All lint jobs passed"
  
  # Check that all vulnerability scan jobs passed
  vuln-check:
    name: "Vulnerability scan status check"
    runs-on: ubuntu-latest
    needs: vuln
    if: always()
    steps:
      - name: Check vulnerability scan results
        run: |
          echo "Vulnerability scan jobs completed"
          # This job will fail if any of the matrix vuln jobs failed
          if [[ "${{ needs.vuln.result }}" != "success" ]]; then
            echo "Some vulnerability scan jobs failed"
            exit 1
          fi
          echo "All vulnerability scan jobs passed"